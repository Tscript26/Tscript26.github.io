[ { "title": "ç”Ÿäº§æ•‘ç«ï¼šå½“ Apollo é‡ä¸Šå•ä¾‹ Beanï¼Œæˆ‘å¦‚ä½•ç”¨ Arthas é€†å¤©æ”¹å‘½ï¼Ÿ", "url": "/posts/java%E7%83%AD%E9%87%8D%E8%BD%BD/", "categories": "Java", "tags": "java, hot-reload, arthas, spring-webflux", "date": "2026-02-12 14:30:00 +0800", "content": "å±æœºç°åœºï¼šå¤±è”çš„ Redis æƒ³è±¡ä¸€ä¸‹ï¼Œä½ åˆšåˆšéƒ¨ç½²äº†ä¸€ä¸ªåŸºäº Spring WebFlux çš„å¾®æœåŠ¡ï¼Œä¿¡å¿ƒæ»¡æ»¡åœ°ç›¯ç€ç›‘æ§ã€‚çªç„¶ï¼Œå‘Šè­¦å…¨çº¿é£˜çº¢ï¼šConnection Refusedã€‚ ä¸€ç•ªæ’æŸ¥åï¼Œä½ å‘ç°äº†ä¸€ä¸ªå°´å°¬çš„çœŸç›¸ï¼šå®¹å™¨å†…çš„ DNS è§£æå‡ºäº†é—®é¢˜ã€‚Apollo é…ç½®ä¸­å¿ƒæ— æ³•è¿æ¥ï¼Œå¯¼è‡´æœåŠ¡å¯åŠ¨æ—¶å›é€€åˆ°äº†é”™è¯¯çš„é»˜è®¤é…ç½®ã€‚Redis å®¢æˆ·ç«¯æ­£å¯¹ç€ä¸€ä¸ªä¸å­˜åœ¨çš„åœ°å€ç–¯ç‹‚å°è¯•ã€‚ æ­¤æ—¶ä½ é¢ä¸´ä¸¤ä¸ªé€‰æ‹©ï¼š é‡å¯å®¹å™¨ï¼šæœ€ç®€å•ï¼Œä½†å¯èƒ½ä¸¢å¤±ç°åœºï¼Œä¸”ç”±äºæ˜¯é«˜æ•æ„Ÿä¸šåŠ¡ï¼Œé¢‘ç¹é‡å¯å¯èƒ½è§¦å‘æ›´ä¸¥å¯†çš„é£æ§å®¡æ ¸ã€‚ çƒ­ä¿®å¤ï¼šåœ¨ä¸é‡å¯çš„å‰æä¸‹ï¼ŒæŠŠç½‘ç»œé€šæ‰ï¼Œå¹¶è®©å†…å­˜é‡Œçš„å¯¹è±¡â€œé†’æ‚Ÿâ€è¿‡æ¥ã€‚ æˆ‘é€‰æ‹©äº†åè€…ã€‚ ç¬¬ä¸€é˜¶æ®µï¼šé€šç½‘ä¸åˆæ­¥å°è¯• 1. å»ºç«‹ç½‘ç»œäº’ä¿¡ é¦–å…ˆè¦è§£å†³ç½‘ç»œå±‚çš„â€œå¤±è”â€ã€‚åœ¨ Linux å®¹å™¨ä¸­ï¼Œ/etc/hosts æ˜¯æˆ‘ä»¬æœ€åçš„å°Šä¸¥ã€‚ # è¿›å…¥å®¹å™¨ï¼Œæ‰‹åŠ¨å°†é…ç½®ä¸­å¿ƒæŒ‡å‘æ­£ç¡® IP echo \"10.x.x.x apollo-meta.server.com\" &gt;&gt; /etc/hosts ç½‘ç»œé€šäº†ï¼ŒApollo å®¢æˆ·ç«¯ç¬é—´æ¢å¤å¿ƒè·³ï¼Œåå°å±æ€§æˆåŠŸæ›´æ–°ã€‚æˆ‘é•¿èˆ’ä¸€å£æ°”ï¼Œä»¥ä¸ºè¿™å°±ç»“æŸäº†ã€‚ 2. å¹»ç­ï¼šä¸ºä»€ä¹ˆ Redis è¿˜æ˜¯ä¸é€šï¼Ÿ ç„¶è€Œï¼ŒRedis çš„è¿æ¥é”™è¯¯ä¾ç„¶åœ¨æŒç»­ã€‚æˆ‘é€šè¿‡ Gemini æ·±å…¥è°ƒç ”å¹¶åæ€äº†ä»£ç ç»†èŠ‚ï¼Œå‘ç°äº†ä¸€ä¸ªæ®‹é…·çš„ç°å®ï¼š å±æ€§ vs å¯¹è±¡ï¼šApollo ä¿®æ”¹çš„æ˜¯å†…å­˜é‡Œçš„ String host å˜é‡ã€‚ å•ä¾‹çš„é¡½å›ºæ€§ï¼šReactiveRedisConnectionFactory æ˜¯å•ä¾‹ï¼ˆSingletonï¼‰ã€‚å®ƒåœ¨å¯åŠ¨æ—¶å°±å·²ç»æ ¹æ®æ—§é…ç½®åˆ›å»ºäº†ç‰©ç†è¿æ¥æ± ã€‚ ç¼ºä¹åˆ·æ–°æœºåˆ¶ï¼šé™¤éä½ åŠ äº† @RefreshScopeï¼Œå¦åˆ™ Spring ä¸ä¼šä¸»åŠ¨å¸®ä½ é”€æ¯è¿™ä¸ªå·²ç»â€œé•¿æ­ªâ€çš„å¯¹è±¡ã€‚ ç¬¬äºŒé˜¶æ®µï¼šå¦è¾Ÿè¹Šå¾„ï¼Œå¯»æ‰¾â€œæ‰‹æœ¯åˆ€â€ æ—¢ç„¶å¸¸è§„æ‰‹æ®µä¸è¡Œï¼Œé‚£å°±åªèƒ½åŠ¨â€œæ‰‹æœ¯â€äº†ã€‚åœ¨å—é™çš„å®¹å™¨ç¯å¢ƒä¸­ï¼Œæˆ‘å¼•å…¥äº†é˜¿é‡Œå·´å·´çš„å¼€æºåˆ©å™¨ â€”â€” Arthas (é˜¿å°”è¨æ–¯)ã€‚ Arthasï¼šJava è¯Šæ–­ç•Œçš„â€œç‘å£«å†›åˆ€â€ï¼Œå®ƒèƒ½è®©ä½ åœ¨ä¸é‡å¯ã€ä¸æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€æ´å¯Ÿç”šè‡³å¹²é¢„ JVM å†…éƒ¨çŠ¶æ€ã€‚ ä¸‹è½½ä¸æŒ‚è½½ curl -O [https://arthas.aliyun.com/arthas-boot.jar](https://arthas.aliyun.com/arthas-boot.jar) java -jar arthas-boot.jar é€‰æ‹©ç›®æ ‡ PID åï¼Œæˆ‘ä»¬å°±æ‹¥æœ‰äº†æ“ä½œè¿è¡Œæ—¶çš„æœ€é«˜æƒé™ã€‚ ç¬¬ä¸‰é˜¶æ®µï¼šç»åœ°åå‡»ï¼Œæ‰‹åŠ¨é‡è½½ Bean æˆ‘ä»¬è¦æ‰§è¡Œçš„æ“ä½œæœ¬è´¨ä¸Šæ˜¯ï¼šä» Spring å®¹å™¨æ‰‹é‡ŒæŠ¢è¿‡æ§åˆ¶æƒ -&gt; æ¯æ‰æ—§å¯¹è±¡ -&gt; éª— Spring é‡æ–°åˆ›å»ºä¸€ä¸ªã€‚ 1. æŠ“å–â€œå…¥åœºåˆ¸â€ï¼šè¯·æ±‚ä¸Šä¸‹æ–‡ (ApplicationContext) Spring æŠŠå®¹å™¨è—å¾—å¾ˆæ·±ï¼Œä½† WebFlux å¤„ç†è¯·æ±‚çš„ DispatcherHandler å¿…ç„¶æŒæœ‰å®ƒã€‚æˆ‘ä»¬åˆ©ç”¨ ttï¼ˆTime Tunnelï¼‰å‘½ä»¤æ‹¦æˆªä¸€ä¸ªè¯·æ±‚ï¼š # æ‹¦æˆª WebFlux å…¥å£ï¼Œæ‹¿åˆ° target å¼•ç”¨ tt -t -c org.springframework.web.reactive.DispatcherHandler handle 2. å¼ºè¡Œé”€æ¯æ—§ Bean æœ‰äº†ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬é€šè¿‡åå°„å¼ºè¡Œæ•²å¼€ BeanFactory çš„å¤§é—¨ï¼ŒæŠŠé‚£ä¸ªåæ‰çš„ reactiveRedisConnectionFactory æ‰”è¿›åƒåœ¾æ¡¶ï¼š # å‡è®¾ tt æ‹¦æˆªåˆ°çš„ç¼–å·æ˜¯ 1005 tt -i 1005 -w '#field=target.getClass().getDeclaredField(\"applicationContext\"), #field.setAccessible(true), #context=#field.get(target), #context.getBeanFactory().destroySingleton(\"reactiveRedisConnectionFactory\")' 3. è§¦å‘â€œæ¶…æ§ƒâ€ï¼šæŒ‰éœ€é‡å»º ç°åœ¨å•ä¾‹æ± é‡Œç©ºäº†ã€‚å½“ä½ å†æ¬¡è°ƒç”¨ getBean æ—¶ï¼ŒSpring ä¼šå‘ç°è¿™ä¸ª Bean æ²¡äº†ï¼Œäºæ˜¯è€è€å®å®åœ°é‡æ–°è¿è¡Œä¸€é @Bean å®šä¹‰çš„æ–¹æ³•ã€‚æ­¤æ—¶ï¼Œå®ƒæ‹¿åˆ°çš„å°±æ˜¯ Apollo æœ€æ–°çš„é…ç½®ï¼š tt -i 1005 -w '#field=target.getClass().getDeclaredField(\"applicationContext\"), #field.setAccessible(true), #context=#field.get(target), #context.getBean(\"reactiveRedisConnectionFactory\")' æŠ€æœ¯å¤ç›˜ï¼šæˆ‘ä»¬å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ æŠ€æœ¯ç‚¹ æ ¸å¿ƒåŸç† ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåš DNS ä¿®æ­£ æ“ä½œç³»ç»Ÿçº§æ‹¦æˆª ç»•è¿‡åŸºç¡€è®¾æ–½æ•…éšœï¼Œå®ç°å¿«é€ŸæœåŠ¡å‘ç°ã€‚ **Arthas tt** å­—èŠ‚ç å¢å¼º åœ¨è¿è¡Œæ—¶â€œå·å–â€ç§æœ‰å¯¹è±¡å¼•ç”¨ï¼Œå®ƒæ˜¯è·å– ApplicationContext çš„æ·å¾„ã€‚ BeanFactory æ“ä½œ å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç† destroySingleton èƒ½ç¡®ä¿æ—§è¿æ¥æ± æ‰§è¡Œ close()ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚ åŠ¨æ€é‡è½½ æ‡’åŠ è½½æœºåˆ¶ å¼ºåˆ¶è§¦å‘ Spring çš„åˆ›å»ºé€»è¾‘ï¼Œä½¿é…ç½®å³æ—¶ç”Ÿæ•ˆã€‚ æ€»ç»“ è¿™æ¬¡â€œæ•‘ç«â€ç»å†å‘Šè¯‰æˆ‘ï¼šç†è§£æ¡†æ¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”è®°ä½é…ç½®å‚æ•°æ›´é‡è¦ã€‚ è™½ç„¶çƒ­åŠ è½½å¾ˆé…·ï¼Œä½†å®ƒå±äºâ€œé«˜é˜¶è¿ç»´â€æ‰‹æ®µã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚éå¿…è¦ï¼Œé‡å¯æ°¸è¿œæ˜¯ä»£ä»·æ›´å°ã€æ›´ç¨³å®šçš„æ–¹æ¡ˆã€‚ä½†åœ¨é‚£äº›ä¸èƒ½é‡å¯çš„æ—¶åˆ»ï¼ŒæŒæ¡è¿™æŠŠâ€œæ‰‹æœ¯åˆ€â€èƒ½è®©ä½ åœ¨ç»å¢ƒä¸­ç¿»ç›˜ã€‚ æç¤ºï¼šçƒ­æ“ä½œæœ‰é£é™©ï¼Œæ¼”ç»ƒæ˜¯ç¬¬ä¸€è¦åŠ¡ï¼ ```" }, { "title": "çº¢é»‘æ ‘", "url": "/posts/red-black-tree/", "categories": "Java, Tutorial", "tags": "java", "date": "2026-01-25 02:00:00 +0800", "content": "çº¢é»‘æ ‘æ˜¯å¯¹â€˜æŸ¥æ‰¾æ•ˆç‡â€™å’Œâ€˜ç»´æŠ¤æˆæœ¬â€™çš„ä¸€ç§ä¼˜é›…å¦¥åã€‚å®ƒä¸è¿½æ±‚ AVL é‚£æ ·çš„æè‡´ç‰©ç†å¹³è¡¡ï¼Œè€Œæ˜¯é€šè¿‡â€˜é»‘é«˜ç›¸ç­‰â€™å’Œâ€˜çº¢ä¸è¿ç»­â€™ç¡®ä¿äº†é€»è¾‘ä¸Šçš„è¿‘ä¼¼å¹³è¡¡ï¼Œä»è€Œåœ¨é¢‘ç¹å˜åŠ¨çš„æ•°æ®åœºæ™¯ä¸‹å±•ç°å‡ºæ›´ä¼˜å¼‚çš„ç»¼åˆæ€§èƒ½ã€‚ çº¢é»‘æ ‘çš„è§„åˆ™ çº¢é»‘æ ‘æœ‰äº”æ¡æœ€æ ¹æœ¬çš„è§„åˆ™ | è§„åˆ™ç¼–å· | è§„åˆ™åç§° | è§„åˆ™å…·ä½“å†…å®¹ | è€å¸ˆçš„æ·±åº¦å¤§ç™½è¯ | | â€”- | â€”â€” | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“ | â€”â€”â€”â€”â€”â€”â€”â€”- | | è§„åˆ™ 1 | èŠ‚ç‚¹é¢œè‰² | æ¯ä¸ªèŠ‚ç‚¹è¦ä¹ˆæ˜¯çº¢è‰²ï¼Œè¦ä¹ˆæ˜¯é»‘è‰²ã€‚ | åªæœ‰ä¸¤ç§èº«ä»½ï¼Œéçº¢å³é»‘ã€‚ | | è§„åˆ™ 2 | æ ¹èŠ‚ç‚¹ç‰¹æ€§ | æ ¹èŠ‚ç‚¹ (Root) å¿…é¡»æ˜¯é»‘è‰²ã€‚ | æ ‘çš„â€œå¤´â€ä¸€å®šè¦ç¨³ï¼Œå¿…é¡»æ˜¯é»‘è‰²çš„ã€‚ | | è§„åˆ™ 3 | å¶å­èŠ‚ç‚¹ç‰¹æ€§ | æ‰€æœ‰ NIL èŠ‚ç‚¹ï¼ˆç©ºèŠ‚ç‚¹ï¼‰ éƒ½æ˜¯é»‘è‰²ã€‚ | æ ‘çš„æœ«ç«¯ï¼ˆçœ‹ä¸è§çš„è™šèŠ‚ç‚¹ï¼‰é»˜è®¤å…¨æ˜¯é»‘è‰²çš„ã€‚ | | è§„åˆ™ 4 | çº¢è‰²ä¸è¿ç»­ | å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œåˆ™å®ƒçš„å­èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²çš„ã€‚ | çº¢çº¢ä¸èƒ½ç›¸è¿ã€‚çº¢èŠ‚ç‚¹åªèƒ½å½“é»‘èŠ‚ç‚¹çš„â€œæŒ‚ä»¶â€ã€‚ | | è§„åˆ™ 5 | é»‘é«˜ç›¸ç­‰ | ä»ä»»ä¸€èŠ‚ç‚¹åˆ°å…¶æ¯ä¸ªå¶å­çš„æ‰€æœ‰ç®€å•è·¯å¾„ï¼Œéƒ½åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ã€‚ | è¿™æ˜¯æœ€æ ¸å¿ƒçš„ä¸€æ¡ã€‚é»‘è‰²èŠ‚ç‚¹æ„æˆäº†æ ‘çš„â€œç­‰é•¿éª¨æ¶â€ã€‚ | graph TD 20((20)):::black --&gt; 10((10)):::black 20((20)):::black --&gt; 30((30)):::black 10((10)) --&gt; 5((5)):::black 10((10)) --&gt; 15((15)):::red 30((30)) --&gt; 25((25)):::red 30((30)) --&gt; 40((40)):::black classDef black fill:#000,stroke:#fff,color:#fff; classDef red fill:#f00,stroke:#fff,color:#fff; graph TD node20[20]:::black node10[10 &amp; 15]:::mixed node30[25 &amp; 30]:::mixed node20 --&gt; node10 node20 --&gt; node30 node10 --&gt; leaf5[5]:::black node30 --&gt; leaf40[40]:::black classDef black fill:#000,stroke:#fff,color:#fff; classDef mixed fill:#555,stroke:#fff,color:#fff,stroke-dasharray: 5 5;" }, { "title": "Java å“åº”å¼ç¼–ç¨‹æ ¸å¿ƒï¼šMono ä¸ Flux æŒ‡å—", "url": "/posts/java-mono-and-flux/", "categories": "Java, Tutorial", "tags": "java", "date": "2026-01-25 02:00:00 +0800", "content": "1. æ ¸å¿ƒæ¦‚å¿µï¼šä»€ä¹ˆæ˜¯å“åº”å¼æµï¼Ÿ åœ¨å“åº”å¼ç¼–ç¨‹ä¸­ï¼Œæ•°æ®ä¸å†æ˜¯è¢«â€œæ‹¿â€è¿‡æ¥çš„ï¼Œè€Œæ˜¯åƒæ°´ä¸€æ ·æµè¿‡æ¥çš„ã€‚ Flux (å¤šå…ƒç´ æµ)ï¼šä»£è¡¨ 0 åˆ° N ä¸ªå…ƒç´ çš„å¼‚æ­¥åºåˆ—ã€‚ä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œä¸€æ¡ä¼ é€å¸¦ï¼Œä¸Šé¢ä¼šé™†ç»­é€æ¥é›¶ä»¶ã€‚ Mono (å•å…ƒç´ æµ)ï¼šä»£è¡¨ 0 åˆ° 1 ä¸ªå…ƒç´ çš„å¼‚æ­¥åºåˆ—ã€‚ä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œä¸€ä¸ªå¿«é€’ç›’ï¼Œæ‰“å¼€åè¦ä¹ˆæœ‰ä¸€ä¸ªé›¶ä»¶ï¼Œè¦ä¹ˆæ˜¯ç©ºçš„ã€‚ æ ¸å¿ƒå®šå¾‹ï¼šä¸è®¢é˜…ï¼Œæ— äº‹å‘ç”Ÿ Nothing happens until you subscribe. ä½ å†™çš„ map, filter, flatMap åªæ˜¯åœ¨â€œé“ºè®¾æ°´ç®¡â€ï¼Œå¦‚æœä½ ä¸æ‰“å¼€æ°´é¾™å¤´ï¼ˆè®¢é˜…ï¼‰ï¼Œä¸€æ»´æ°´ï¼ˆæ•°æ®ï¼‰éƒ½ä¸ä¼šæµè¿‡ã€‚ 2. ä¸ºä»€ä¹ˆ return å°±èƒ½æ‰§è¡Œï¼Ÿ åœ¨ Spring WebFluxï¼ˆå¦‚ Controller å±‚ï¼‰ä¸­ï¼Œä½ é€šå¸¸åªå†™ return è€Œä¸å†™ .subscribe()ï¼Œä½†ä»£ç ä¾ç„¶è¿è¡Œäº†ã€‚è¿™æ˜¯å› ä¸ºï¼š æ¡†æ¶ä»£åŠ³ï¼šSpring WebFlux å……å½“äº†â€œæœ€ç»ˆè®¢é˜…è€…â€ã€‚ æ‰§è¡Œé“¾è·¯ï¼š ä½ äº¤å‡ºä¸€å¼ â€œæ°´ç®¡è®¾è®¡å›¾â€ï¼ˆreturn Mono/Fluxï¼‰ã€‚ Spring æ‹¿åˆ°åï¼Œåœ¨åº•å±‚è‡ªåŠ¨è°ƒç”¨äº† .subscribe()ã€‚ æ•°æ®å¼€å§‹æµåŠ¨ï¼Œæœ€ç»ˆé€šè¿‡ HTTP å“åº”å‘ç»™ç”¨æˆ·ã€‚ æ³¨æ„ï¼š æ°¸è¿œä¸è¦åœ¨ Controller å†…éƒ¨â€œæ–­å¼€â€è¿™ä¸ªé“¾æ¡ã€‚å¦‚æœä½ æ²¡æœ‰ return æŸä¸ªæµï¼Œé‚£ä¹ˆé‚£ä¸ªæµé‡Œçš„é€»è¾‘ï¼ˆå¦‚æ•°æ®åº“ä¿å­˜ï¼‰æ°¸è¿œä¸ä¼šè¢«è§¦å‘ã€‚ 3. Subscribe çš„ä¸åŒç”¨æ³• å¦‚æœä½ åœ¨é Web ç¯å¢ƒï¼ˆå¦‚æµ‹è¯•æˆ–åå°å¼‚æ­¥ä»»åŠ¡ï¼‰ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨è§¦å‘æµã€‚ A. ç®€å•è§¦å‘ åªå¯åŠ¨æµï¼Œä¸å…³å¿ƒç»“æœã€‚ source.subscribe(); B. å¤„ç†æ•°æ® (onNext) æ‹¿åˆ°æ•°æ®åè¿›è¡Œå¤„ç†ã€‚ source.subscribe(data -&gt; { System.out.println(\"æ”¶åˆ°æ•°æ®: \" + data); }); C. å…¨åŠŸèƒ½è®¢é˜… (å¤„ç†æ•°æ® + é”™è¯¯ + å®Œæˆ) æœ€å®Œæ•´çš„ç›‘å¬æ–¹å¼ã€‚ source.subscribe( data -&gt; System.out.println(\"æ•°æ®: \" + data), // æ­£å¸¸å¤„ç† err -&gt; System.err.println(\"å‡ºé”™: \" + err), // å¼‚å¸¸å¤„ç† (ç±»ä¼¼ catch) () -&gt; System.out.println(\"å¤„ç†å®Œæ¯•ï¼\") // å®Œæˆé€šçŸ¥ (ç±»ä¼¼ finally) ); 4. å…³é”®æ“ä½œç¬¦ï¼šMap vs FlatMap è¿™æ˜¯æ–°æ‰‹æœ€å®¹æ˜“æ··æ·†çš„åœ°æ–¹ï¼š Map (ä¸€å¯¹ä¸€å˜æ¢)ï¼š åŠ¨ä½œï¼šæŠŠè‹¹æœåˆ‡æˆç‰‡ã€‚ åœºæ™¯ï¼šæŠŠ User å¯¹è±¡è½¬æ¢æˆ UserResponse å¯¹è±¡ã€‚ ä»£ç ï¼š.map(user -&gt; user.getName()) FlatMap (ä¸€å¯¹å¤š/å¼‚æ­¥å˜æ¢)ï¼š åŠ¨ä½œï¼šæŠŠè®¢å• ID æ‹¿å»æŸ¥æ•°æ®åº“ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„è®¢å•è¯¦æƒ…æµã€‚ åœºæ™¯ï¼šå½“ä½ éœ€è¦è°ƒç”¨å¦ä¸€ä¸ªè¿”å› Mono æˆ– Flux çš„å¼‚æ­¥æ–¹æ³•æ—¶ã€‚ ä»£ç ï¼š.flatMap(id -&gt; repository.findById(id)) 5. ä¸ Go å¼‚æ­¥ (go func) çš„åŒºåˆ« å¦‚æœä½ ç†Ÿæ‚‰ Go è¯­è¨€ï¼Œå¯ä»¥å¯¹æ¯”ç†è§£ï¼š ç‰¹æ€§ Go go func(){} Java Mono/Flux é£æ ¼ å‘½ä»¤å¼ï¼šåƒå†™åŒæ­¥ä»£ç ä¸€æ ·å†™å¼‚æ­¥ã€‚ å£°æ˜å¼ï¼šåƒæ­ç§¯æœ¨ä¸€æ ·æ‹¼è£…é€»è¾‘æµã€‚ çŠ¶æ€ æœ‰ç‹¬ç«‹çš„åç¨‹æ ˆï¼Œå˜é‡éšè°ƒéšç”¨ã€‚ æ— çŠ¶æ€å›è°ƒé“¾ï¼Œå¿…é¡»åœ¨æµä¸­ä¼ é€’å˜é‡ã€‚ èƒŒå‹ éœ€é€šè¿‡ Channel æ‰‹åŠ¨æ§åˆ¶ã€‚ åŸç”Ÿæ”¯æŒï¼šä¸‹æ¸¸å¯ä»¥å‘Šè¯‰ä¸Šæ¸¸æ…¢ç‚¹å‘ã€‚ æŠ¥é”™ if err != nil ç›´æ¥å¤„ç†ã€‚ å¿…é¡»ç”¨ onErrorResume ç­‰æ“ä½œç¬¦å¤„ç†ã€‚ 6. é¿å‘æŒ‡å— (Checklist) åˆ«å¿˜äº† Returnï¼šæ–¹æ³•é‡Œå®šä¹‰çš„ Mono/Flux ä¸€å®šè¦ return æˆ–è€…æ˜¯ä½œä¸ºè¿”å›æµçš„ä¸€éƒ¨åˆ†ã€‚ é¿å…å¤šæ¬¡è®¢é˜…ï¼šä¸€ä¸ªæµé€šå¸¸åªåº”è¯¥è¢«è®¢é˜…ä¸€æ¬¡ã€‚ ä¸è¦åœ¨æµé‡Œç”¨é˜»å¡ä»£ç ï¼šåƒä¸‡ä¸è¦åœ¨ map æˆ– flatMap é‡Œç”¨ Thread.sleep() æˆ–åŒæ­¥çš„æ•°æ®åº“é©±åŠ¨ï¼Œè¿™ä¼šç¬é—´å¡æ­»æ•´ä¸ªç³»ç»Ÿçš„äº‹ä»¶ç¯ã€‚ 7. å¸¸ç”¨åè¯ä¸­è‹±æ–‡å¯¹ç…§ (Terminology) å¼‚æ­¥ (Asynchronous): ä¸åŸåœ°ç­‰å¾…ç»“æœã€‚ éé˜»å¡ (Non-blocking): çº¿ç¨‹ä¸æŒ‚èµ·ã€‚ æ“ä½œç¬¦ (Operator): å¤„ç†æµçš„æ–¹æ³•ï¼ˆmap, filterç­‰ï¼‰ã€‚ èƒŒå‹ (Backpressure): æµé‡æ§åˆ¶æœºåˆ¶ã€‚ å‰¯ä½œç”¨ (Side Effect): ä¸å½±å“æ•°æ®æœ¬èº«çš„é¢å¤–åŠ¨ä½œï¼ˆå¦‚ doOnNextï¼‰ã€‚ FAQ 1. ä»€ä¹ˆæ˜¯èƒŒå‹ï¼Ÿ èƒŒå‹ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ å½“ä¸‹æ¸¸å¤„ç†ä¸è¿‡æ¥æ—¶ï¼Œå‘ä¸Šæ¸¸å‘å‡ºçš„åé¦ˆä¿¡å·ã€‚ å¦‚æœæ²¡æœ‰èƒŒå‹ï¼Œä¸Šæ¸¸ä¸€ç›´è¾“å‡ºï¼Œä¸‹æ¸¸æ— æ³•æ¶ˆè´¹ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šé€ æˆæº¢å‡ºï¼ˆå†…å­˜æº¢å‡ºOOMï¼‰ã€‚ ä¸€ä¸ªæ¯”è¾ƒå½¢è±¡çš„ç±»æ¯”ï¼Œ æƒ³è±¡ä½ åœ¨å‚åŠ ä¸€ä¸ªåƒåŒ…å­æ¯”èµ›ï¼š ä¸Šæ¸¸ (Publisher)ï¼šå¨å¸ˆï¼Œè´Ÿè´£ä¸åœåœ°è’¸åŒ…å­å¹¶æŠŠå®ƒä»¬æ”¾åˆ°ä½ çš„ç›˜å­é‡Œã€‚ ä¸‹æ¸¸ (Subscriber)ï¼šä½ ï¼Œè´Ÿè´£æŠŠç›˜å­é‡Œçš„åŒ…å­åƒæ‰ã€‚ å¦‚æœæ²¡æœ‰èƒŒå‹ï¼š å¨å¸ˆä¸ç®¡ä½ åƒå¾—å¿«æ…¢ï¼Œæ¯ç§’é’Ÿå¾€ä½ ç›˜å­é‡Œæ”¾ 10 ä¸ªåŒ…å­ã€‚ä½  5 ç§’é’Ÿæ‰åƒå¾—ä¸‹ä¸€ä¸ªã€‚å¾ˆå¿«ï¼Œä½ çš„ç›˜å­å †ä¸ä¸‹äº†ï¼ŒåŒ…å­æ‰äº†ä¸€åœ°ï¼Œç”šè‡³æŠŠä½ åŸ‹äº†èµ·æ¥ï¼ˆOOMï¼‰ å¦‚æœæœ‰èƒŒå‹ï¼š ä½ å’Œå¨å¸ˆä¹‹é—´æœ‰ä¸€ä¸ªçº¦å®šã€‚ä½ ä¼šå‘Šè¯‰å¨å¸ˆï¼šâ€œæˆ‘ç°åœ¨èƒƒå£å¥½ï¼Œå…ˆç»™æˆ‘å‘ 3 ä¸ªâ€ï¼Œæˆ–è€…â€œæˆ‘åƒä¸æ¶ˆäº†ï¼Œå…ˆåœ 10 ç§’åˆ«æ”¾äº†â€ã€‚å¨å¸ˆæ ¹æ®ä½ çš„åé¦ˆæ¥è°ƒæ•´ç”Ÿäº§é€Ÿåº¦ã€‚ 1.1. èƒŒå‹çš„å·¥ä½œåŸç† èƒŒå‹éµå¾ª å“åº”å¼æµè§„èŒƒ (Reactive Streams Specification)ï¼Œä¸»è¦é€šè¿‡ Subscription å¯¹è±¡æ¥å®ç°ã€‚ å…·ä½“æ­¥éª¤ï¼š è®¢é˜…ï¼šè®¢é˜…è€…å‘å‘å¸ƒè€…å‘èµ·è®¢é˜…ã€‚ å»ºç«‹è¿æ¥ï¼šå‘å¸ƒè€…ç»™è®¢é˜…è€…å‘é€ä¸€ä¸ª Subscriptionï¼ˆåˆçº¦ï¼‰ã€‚ è¯·æ±‚æ•°æ®ï¼šè®¢é˜…è€…è°ƒç”¨ subscription.request(n)ã€‚è¿™æ­¥å¾ˆå…³é”®ï¼Œå®ƒæ˜ç¡®å‘Šè¯‰ä¸Šæ¸¸ï¼šâ€œæˆ‘åªè¦ n ä¸ªæ•°æ®â€ã€‚ å‘é€æ•°æ®ï¼šå‘å¸ƒè€…æ”¶åˆ°è¯·æ±‚ï¼Œå‘é€ ä¸å¤šäº n ä¸ª çš„æ•°æ®ã€‚ å¾ªç¯ï¼šè®¢é˜…è€…å¤„ç†å®Œè¿™ n ä¸ªåï¼Œæ ¹æ®è‡ªå·±çš„çŠ¶æ€ï¼Œå†æ¬¡è°ƒç”¨ request(m)ã€‚ 1.2. Project Reactor (Mono/Flux) ä¸­çš„èƒŒå‹ç­–ç•¥ å¦‚æœä½ æ²¡æœ‰æ‰‹åŠ¨æ§åˆ¶ requestï¼ŒFlux é»˜è®¤ä¼šå¸®ä½ å¤„ç†å¥½ã€‚ä½†å½“æ•°æ®çœŸçš„çˆ†æ»¡æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡æ“ä½œç¬¦å®šä¹‰ç­–ç•¥ï¼š onBackpressureBuffer()ï¼šæŠŠæº¢å‡ºçš„æ•°æ®å…ˆå­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼ˆç±»ä¼¼äºå¿«é€’ä¸­è½¬ç«™ï¼‰ã€‚ onBackpressureDrop()ï¼šå¤„ç†ä¸è¿‡æ¥çš„æ•°æ®ç›´æ¥æ‰”æ‰ï¼ˆå°±åƒå¤ªæŒ¤äº†å°±ä¸è®©ä¸Šè½¦äº†ï¼‰ã€‚ onBackpressureLatest()ï¼šåªä¿ç•™æœ€æ–°çš„é‚£ä¸ªæ•°æ®ï¼Œæ—§çš„å…¨éƒ¨æ‰”æ‰ï¼ˆæ¯”å¦‚è‚¡ç¥¨è¡Œæƒ…ï¼Œæˆ‘åªå…³å¿ƒæœ€æ–°çš„ä»·æ ¼ï¼‰ã€‚ onBackpressureError()ï¼šå¤„ç†ä¸è¿‡æ¥å°±ç›´æ¥æŠ¥é”™ã€‚ ç¤ºä¾‹ä»£ç  Flux.interval(Duration.ofMillis(1)) .onBackpressureLatest() // ç­–ç•¥ï¼šåªç•™æœ€åä¸€ä¸ª .concatMap(data -&gt; Mono.delay(Duration.ofSeconds(1)).thenReturn(data)) .subscribe(data -&gt; System.out.println(\"å½“å‰æœ€æ–°æ•°æ®: \" + data)); 2. ä»€ä¹ˆæ˜¯subscribeï¼Œä»¥åŠä»£ç çœŸå®çš„æ‰§è¡Œé¡ºåºï¼Ÿ ä»¥ä¸‹æ˜¯ä¸€ä¸ªéå¸¸å½¢è±¡çš„æ‰§è¡Œä¾‹å­ public Mono&lt;String&gt; register(User user) { // 1. ä¿å­˜ç”¨æˆ·ï¼ˆè¿™ä¸ªéœ€è¦ returnï¼Œå› ä¸ºç”¨æˆ·è¦çœ‹åˆ°ç»“æœï¼‰ Mono&lt;String&gt; result = userRepository.save(user); // 2. å¼‚æ­¥å‘é‚®ä»¶ï¼ˆä¸éœ€è¦ return ç»™ç”¨æˆ·ï¼Œæ‰€ä»¥æ‰‹åŠ¨è®¢é˜…ï¼‰ emailService.sendWelcomeEmail(user) .subscribe( success -&gt; System.out.println(\"é‚®ä»¶å‘é€æˆåŠŸ\"), error -&gt; System.err.println(\"é‚®ä»¶å‘é€å¤±è´¥: \" + error.getMessage()) ); return result; } ä»ä»£ç è·¯å¾„ä¸Šçœ‹ï¼Œ Mono&lt;String&gt; resultä¼¼ä¹æ˜¯æ—©äºç¬¬äºŒæ­¥çš„é‚®ä»¶å‘é€å‰æ‰§è¡Œçš„ï¼Œä½†å®é™…ä¸Šï¼Œæ‰§è¡Œé¡ºåºåè€Œæ˜¯2 -&gt; 1ã€‚ å› ä¸ºwebfluxç¼–ç¨‹ä¸­ï¼Œ1åªä»£è¡¨äº†ä¸€ä¸ªâ€œè®¾è®¡å›¾â€ï¼Œæ²¡æœ‰çœŸæ­£æ‰§è¡Œï¼Œåè€Œæ˜¯ç¬¬äºŒæ­¥ï¼Œç”±äºæ‰‹åŠ¨ä½¿ç”¨äº†subscribeï¼Œä¼šç«‹åˆ»å¼‚æ­¥å¯åŠ¨ï¼ˆåœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼‰ã€‚ åœ¨return çš„æ—¶å€™ï¼Œè®¾è®¡å›¾è¢«è¿”å›ç»™äº†springï¼Œspringåœ¨æ¥æ”¶åˆ°äº†è®¾è®¡å›¾ä¹‹åï¼Œæ‰ä¼šå¸®ä½ è°ƒç”¨subscribeï¼Œæ­¤æ—¶ï¼Œä¿å­˜ç”¨æˆ·çš„æ“ä½œæ‰å¼€å§‹æ‰§è¡Œã€‚" }, { "title": "åä¸ºå°è‰ºæ¥å…¥åˆ†æ", "url": "/posts/huawei-agent/", "categories": "Work", "tags": "analysis", "date": "2025-12-03 17:00:00 +0800", "content": "å°è‰º A2A æ¨¡å¼å¼€å‘è§„èŒƒï¼ˆé€Ÿè§ˆï¼‰ å°è‰ºæ˜¯2025å¹´11æœˆä»½å¼€æ”¾çš„A2Aèƒ½åŠ›ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å°è‰ºè®¿é—®ç¬¬ä¸‰æ–¹å¼€å‘çš„agentæœåŠ¡ã€‚ï¼ˆç›®å‰åº”è¯¥è¿˜æ˜¯éœ€è¦å’Œå•†åŠ¡è”ç³»ï¼Œè¿™ä¸ªæ²¡æœ‰å¹¿æ³›å¼€æ”¾ï¼‰ åä¸ºå®˜æ–¹æ–‡æ¡£ éœ€è¦åœ¨åˆ›å»ºå¥½è´¦å·ä¹‹åï¼Œåœ¨å°è‰ºå¼€å‘å¹³å°é€šè¿‡A2Aæ¨¡å¼åˆ›å»ºæ™ºèƒ½ä½“ï¼Œé…ç½®æ™ºèƒ½ä½“çš„åç§°ï¼Œæ™ºèƒ½ä½“æè¿°ï¼ˆç”¨äºåšæ„å›¾åˆ†å‘ï¼‰ï¼ŒAPI URLï¼Œä¼šè¯ç»´æŒçš„æ–¹å¼ï¼Œä»¥åŠè®¤è¯æ–¹å¼ç­‰ é¢å‘æœ¬åœ° Agent Server é€‚é…åä¸ºå°è‰º A2A åè®®çš„å¼€å‘è¯´æ˜ï¼Œä¾¿äºåç«¯å¿«é€Ÿå¯¹æ¥å’Œè‡ªæµ‹ã€‚ 1. æ¥å£å½¢æ€ å•ä¸€å…¥å£ï¼šPOST /agent/message åè®®ï¼šJSON-RPC 2.0 å¿…è¦ Headerï¼š Content-Type: application/json agent-session-idï¼ˆé™¤ initialize å¤–å¿…éœ€ï¼‰ Authorizationï¼ˆä»… initialize ç”¨ï¼Œæ ¡éªŒè§„åˆ™è‡ªå®šï¼‰ è¿”å›ï¼šSSEï¼ˆtext/event-streamï¼‰ï¼Œæ¯å¸§æ˜¯ JSON-RPC æˆåŠŸå“åº”ï¼Œresult ä¸ºçŠ¶æ€æˆ–å†…å®¹äº‹ä»¶ã€‚ 2. æ”¯æŒçš„ method initializeï¼šç”Ÿæˆå¹¶è¿”å› agentSessionIdï¼ˆå¯æ˜ å°„åˆ°ä¸šåŠ¡ä¾§ sessionï¼Œå¦‚ chatSession/createï¼‰ã€‚ notifications/initializedï¼šåˆå§‹åŒ–å®Œæˆå›è°ƒï¼ŒHTTP 200ã€‚ message/streamï¼šæ ¸å¿ƒæµå¼æ¥å£ã€‚ tasks/cancelï¼šå–æ¶ˆå½“å‰ä»»åŠ¡ã€‚ clearContextï¼šæ¸…ç†ä¼šè¯/ä¸Šä¸‹æ–‡ï¼ˆå¯è°ƒç”¨ä¸šåŠ¡ä¾§åˆ é™¤æ¥å£ï¼Œå¦‚ chatSession/deleteï¼ŒæŒ‰éœ€å®ç°ï¼‰ã€‚ authorize / deauthorizeï¼šè´¦å·æˆæƒç»‘å®š/è§£ç»‘ï¼ˆç¤ºä¾‹å ä½ï¼Œæ ¹æ®ä¸šåŠ¡å¯¹æ¥ï¼‰ã€‚ 3. message/stream è¯·æ±‚æ ¼å¼ { \"jsonrpc\": \"2.0\", \"id\": \"msg-1\", // æœ¬æ¬¡ RPC å”¯ä¸€ ID \"method\": \"message/stream\", \"params\": { \"id\": \"task-001\", // ä»»åŠ¡ IDï¼ˆæ•´åœºæµå¼äº¤äº’å†…ä¿æŒä¸å˜ï¼‰ \"sessionId\": \"sess-1\", // å®¢æˆ·ç«¯åˆ†é…çš„ä¼šè¯ IDï¼Œåˆ‡æ¢å³è§†ä¸ºæ–°ä¸Šä¸‹æ–‡ï¼ˆæœåŠ¡ç«¯åªè´Ÿè´£ç®¡ç†ï¼Œä¸è´Ÿè´£ç”Ÿæˆï¼‰ \"agentLoginSessionId\": \"login-xxx\", // ç”¨æˆ·ç™»å½•æ€ï¼ˆè‹¥æœ‰ï¼‰ \"message\": { \"role\": \"user\", \"parts\": [ { \"kind\": \"text\", \"text\": \"ç”¨æˆ·è¾“å…¥çš„ Query\" } // { \"kind\": \"file\", \"file\": { name, mimeType, bytes|uri } } // { \"kind\": \"data\", \"data\": { ...ç»“æ„åŒ–æ•°æ®... } } ] } } } 4. æœåŠ¡ç«¯è¿”å›äº‹ä»¶ç±»å‹ï¼ˆSSE å¸§ä¸­çš„ resultï¼‰ TaskStatusUpdateEventï¼ˆçŠ¶æ€äº‹ä»¶ï¼‰ å­—æ®µï¼štaskIdã€kind=status-updateã€finalã€status.stateï¼ˆsubmitted working input-required completed canceled failed unknownï¼‰ã€status.message.parts[]ï¼ˆå¯å¡«è¿›åº¦æè¿°ï¼‰ã€‚ TaskArtifactUpdateEventï¼ˆå†…å®¹äº‹ä»¶ï¼‰ å­—æ®µï¼štaskIdã€kind=artifact-updateã€appendã€lastChunkã€finalã€artifact.artifactIdã€artifact.parts[]ã€‚ parts ç±»å‹ textï¼šæ­£æ–‡ï¼Œæ”¯æŒ markdownã€‚ reasoningTextï¼šæ€è€ƒè¿‡ç¨‹ã€‚ dataï¼šç»“æ„åŒ–æ•°æ®ï¼ˆå¡ç‰‡ã€è·³è½¬ç­‰ï¼Œè§ä¸‹ï¼‰ã€‚ fileï¼šæ–‡ä»¶ï¼ˆä¸åœºæ™¯ç›¸å…³æ—¶ä½¿ç”¨ï¼‰ã€‚ 5. æµå¼è¯­ä¹‰å»ºè®® é¦–å¸§ï¼šè¿”å› status-update state=working final=falseã€‚ ä¸­é—´å¸§ï¼šå¤šæ¬¡ artifact-update append=true lastChunk=false final=falseã€‚ ç»“æŸå¸§ï¼šè¡¥ä¸€ä¸ª status-update state=completed final=trueï¼ˆè‹¥æœ‰å†…å®¹ï¼Œæœ€åä¸€æ¡ artifact-update çš„ lastChunk=true final=false ä¹Ÿå¯é…åˆï¼‰ã€‚ å–æ¶ˆï¼šæ”¶åˆ° tasks/cancel åè¿”å› status-update state=canceled final=trueï¼Œå¹¶åœæ­¢ç»§ç»­æ¨é€ã€‚ å¤±è´¥ï¼šè¿”å› status-update state=failed final=trueï¼Œmessage ä¸­å¸¦é”™è¯¯åŸå› ã€‚ 6. è·³è½¬/å¡ç‰‡ï¼ˆkind=dataï¼‰ åœ¨ artifact.parts é‡Œå¢åŠ ï¼š { \"kind\": \"data\", \"data\": { // commandsï¼šè§¦å‘ç«¯èƒ½åŠ› \"commands\": [ { \"header\": { \"namespace\": \"demo\", \"name\": \"openLink\" }, \"payload\": { \"url\": \"https://...\" } } ], // cardsInfoï¼šä¸šåŠ¡å¡ç‰‡ï¼Œå¡ç‰‡æ¨¡æ¿éœ€åœ¨å°è‰ºå¼€æ”¾å¹³å°æ³¨å†Œ \"cardsInfo\": { \"cardName\": \"service_link\", \"cardData\": { \"items\": [{ \"title\": \"æŸ¥çœ‹è¯¦æƒ…\", \"url\": \"https://...\" }] }, \"displayType\": \"DisplayFaCard\" }, // chipsInfoï¼šåº•éƒ¨ Chipsï¼Œå¯ç”¨ superlink/h5/app å°ç¨‹åºåè®® \"chipsInfo\": { \"displayChips\": { \"chipsList\": [{ \"content\": \"superlink://vassistant?text=æ‰“å¼€H5\", \"domain\": \"agent\" }] } }, // referenceï¼šå¼•ç”¨/é“¾æ¥å¡ç‰‡ï¼ŒwebLink.url å¯æ”¾ H5/å°ç¨‹åºåœ°å€ï¼ŒstartMode åŒºåˆ†è·³è½¬æ–¹å¼ï¼ˆéœ€ä¸å®¢æˆ·ç«¯çº¦å®šï¼‰ \"reference\": { \"items\": [{ \"params\": { \"name\": \"h5_link\", \"source\": \"agent\" }, \"card\": { \"type\": \"webLink\", \"params\": { \"title\": \"å‰å¾€H5\", \"link\": { \"webLink\": { \"url\": \"https://...\", \"startMode\": 1 } } } } }] } } } æç¤ºï¼šdisplayTypeã€startMode ç­‰éœ€æŒ‰å®¢æˆ·ç«¯çº¦å®šå–å€¼ï¼›å¡ç‰‡æ¨¡æ¿åéœ€åœ¨å°è‰ºä¾§å·²æ³¨å†Œã€‚ 7. æ¸…ç†ä¼šè¯ clearContext å»ºè®®æ˜ å°„åˆ°ä¸šåŠ¡ä¾§ä¼šè¯åˆ é™¤ï¼ˆå¦‚ POST /api/ai/chat/chatSession/deleteï¼‰ï¼Œæºå¸¦ chatSessionId/agentSessionIdã€‚è‹¥æ¥å£æœªéªŒè¯ï¼Œè¯·åœ¨æ—¥å¿—ä¸­æ ‡è®°ã€‚ æœåŠ¡ç«¯å¯ä¿æŒæ— çŠ¶æ€ï¼Œå®¢æˆ·ç«¯é€šè¿‡æ›´æ¢ sessionId è§†ä¸ºæ–°ä¸Šä¸‹æ–‡ã€‚ 8. æœ€å°è‡ªæµ‹æ¸…å• initialize æ­£å¸¸è¿”å› agentSessionIdã€‚ message/stream èƒ½äº§å‡ºï¼šworking çŠ¶æ€ -&gt; è‹¥å¹² artifact-update -&gt; completed çŠ¶æ€ã€‚ å–æ¶ˆï¼štasks/cancel åæ”¶åˆ° canceled çŠ¶æ€ï¼Œåç»­ä¸å†æ¨é€ã€‚ å¤±è´¥åœºæ™¯ï¼šè¿œç«¯æŠ¥é”™æ—¶è¿”å› failed çŠ¶æ€ã€‚ clearContext èƒ½æ­£å¸¸é€ä¼ /è°ƒç”¨ä¸šåŠ¡åˆ é™¤æ¥å£ï¼ˆå¦‚æœ‰ï¼‰ã€‚ è¿”å›çš„ data å¡ç‰‡å­—æ®µç¬¦åˆå®¢æˆ·ç«¯çº¦å®šï¼ˆå‘½åã€æ¨¡æ¿ã€startModeï¼‰ã€‚ 9. å¸¸è§é—®é¢˜ sessionID,agentSessionId,agentLoginSessionIdï¼Œåˆ†åˆ«æ˜¯æ€ä¹ˆç®¡ç†çš„ï¼Ÿ sessionID: æ˜¯ç”±å®¢æˆ·ç«¯ï¼ˆå°è‰ºï¼‰åœ¨å‘èµ·message/streamçš„æ—¶å€™å¸¦ä¸Šçš„ï¼Œç”¨äºè®°å½•çœŸå®çš„ä¼šè¯è¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ²¡æœ‰åˆ›å»ºæƒé™ï¼ˆå¯èƒ½åä¸ºå†…éƒ¨åæœŸä¼šå…è®¸åŒä¸€ä¸ªsessionIDä½¿ç”¨ä¸åŒçš„æ™ºèƒ½ä½“æ¥å®ç°å®Œæ•´çš„åŠŸèƒ½ï¼‰ agentSessionIdï¼š å®¢æˆ·ç«¯æ‰“å¼€ç¬¬ä¸‰æ–¹æ™ºèƒ½ä½“ç•Œé¢çš„æ—¶å€™ï¼Œä¼šå°è¯•å°è¯•è¿›è¡Œåˆå§‹åŒ–ï¼Œè·å–å¯¹åº”çš„agentSessionIdï¼ˆåŸæ–‡ï¼Œæœªç¡®è®¤ï¼‰ï¼Œä»ä¸ªäººç†è§£æ–¹é¢ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯ç”¨æ¥æ ‡è®°å½“å‰å®¢æˆ·ç«¯å¯åŠ¨çš„é’ˆå¯¹äºç¬¬ä¸‰æ–¹æ™ºèƒ½ä½“çš„SessionIDï¼Œå¹¶éå®é™…ä¼šè¯çš„SessionId agentLoginSessionIdï¼š åŸæ–‡è¯´æ˜ä¸ºæ™ºèƒ½ä½“å†…éƒ¨ç”¨äºç®¡ç†ç”¨æˆ·çš„ä¸€æ¬¡ç™»å½•çš„ï¼Œä¸ªäººè®¤ä¸ºæ™ºèƒ½ä½“å†…éƒ¨ç”¨äºç®¡ç†ç”¨æˆ·ç™»å½•ä½¿ç”¨çš„ï¼Œæ¯”æ–¹è¯´ï¼Œæ•°æ®åº“é”®ä½¿ç”¨ç”¨æˆ·sessionidï¼Œå†…éƒ¨ä¿å­˜UserInfo,accessTokenç­‰ä¿¡æ¯ã€‚ï¼ˆåä¸ºè¦æ±‚ç¬¬ä¸‰æ–¹agentæä¾›deauthorizeåŠŸèƒ½ï¼Œä»¥ç¡®ä¿å› æ­¤å®‰å…¨ï¼‰" }, { "title": "ä»£ç æ‰§è¡Œæ²™ç›’ï¼ˆ", "url": "/posts/my-sandbox/", "categories": "Learn, Work", "tags": "analysis, agent, AI", "date": "2025-12-03 08:00:00 +0800", "content": "ä¸ºä»€ä¹ˆè¦é‡æ–°å†™ä¸€ä¸ªæ²™ç›’ï¼Ÿ åŸæœ‰èƒ½åŠ›ä¸è¶³ï¼Œç¼ºå°‘å®šåˆ¶åŒ– venvï¼Œç¼ºå°‘å‚æ•°éªŒè¯ï¼Œç¼ºå°‘æ‰§è¡Œæ—¥å¿—çš„æŒä¹…åŒ–ã€‚åŸæœ‰ Dify ä»£ç èŠ‚ç‚¹è™½ç„¶å†™äº†å‚æ•°æ ¡éªŒï¼Œä½†å®é™…ä¸Šä¸å†™ä¹Ÿèƒ½è·‘ï¼Œé£é™©å¾ˆé«˜ã€‚ é¢å¤–å®ç°äº†å“ªäº›åŠŸèƒ½ï¼Ÿ python è™šæ‹Ÿç¯å¢ƒå’Œä¾èµ–å®ç°åŠ¨æ€ç®¡ç†ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ã€æ¥å£ã€kafkaä¸‰ç§æ–¹å¼è¿›è¡Œè™šæ‹Ÿç¯å¢ƒç®¡ç† æ›´å¥½çš„å‚æ•°æ ¡éªŒåŠŸèƒ½ï¼Œæ”¯æŒè¾“å…¥å’Œè¾“å‡ºå‚æ•°æ ¡éªŒï¼Œå¦‚æœæœ‰è¾“å‡ºå‚æ•°æ ¡éªŒï¼Œå¯ä»¥è¾“å‡ºæ ¼å¼åŒ–çš„jsonæ•°æ® å®æ–½ç»†èŠ‚ ä»£ç è·¯å¾„ï¼šubuntu/home/dify-sandboxï¼ŒåŸºäº dify-sandbox äºŒæ¬¡å¼€å‘ã€‚ å†…éƒ¨ç»“æ„ï¼šæ ¸å¿ƒæœåŠ¡ï¼ˆæ²™ç›’ APIï¼‰ã€æ‰§è¡Œå¼•æ“ï¼ˆæ‹‰èµ·éš”ç¦»å®¹å™¨ / venvï¼‰ã€æ—¥å¿—æ¨¡å—ï¼ˆæŒä¹…åŒ–è¿è¡Œè®°å½•ï¼‰ã€‚ è¿è¡Œæ¨¡å¼ï¼šæ”¯æŒé…ç½®æ–‡ä»¶æ¨¡å¼ã€REST API æ¨¡å¼ã€Kafka äº‹ä»¶é©±åŠ¨æ¨¡å¼ä¸‰ç§å…¥å£ï¼Œé»˜è®¤å¯ç”¨å®‰å…¨å‚æ•°æ ¡éªŒã€‚ å¿«é€Ÿä¸Šæ‰‹ï¼ˆæ¨¡æ¿ï¼‰ # 1) åˆ‡æ¢åˆ°é¡¹ç›® cd ubuntu/home/dify-sandbox # 2) åˆå§‹åŒ–è™šæ‹Ÿç¯å¢ƒ + å®‰è£…ä¾èµ– sh build/build_arm64.sh # æ ¹æ®è‡ªå·±çš„ç¯å¢ƒé€‰æ‹© # 3) å¯åŠ¨æœåŠ¡ ./main # é»˜è®¤æœ¬åœ°ç«¯å£ 8194ï¼Œå¯åœ¨ config.yaml ä¸­ä¿®æ”¹ é…ç½®ç¤ºä¾‹ï¼ˆæ¨¡æ¿ï¼‰ sandbox: venvs: default: requirements: requirements.txt python: python3.11 io: input_schema: schema/input.json output_schema: schema/output.json logging: sink: postgresql://user:pwd@host:5432/sandbox retain_days: 30 runtime: mode: api # api | file | kafka max_timeout: 60s API è°ƒç”¨ç¤ºä¾‹ï¼ˆæ¨¡æ¿ï¼‰ curl -X POST http://localhost:8080/run \\ -H \"Content-Type: application/json\" \\ -d '{ \"venv\": \"default\", \"entry\": \"scripts/hello.py\", \"inputs\": {\"name\": \"sandbox\"}, \"validate_output\": true }' èƒ½åŠ›æ¸…å•ï¼ˆæ¨¡æ¿ï¼‰ éš”ç¦»æ‰§è¡Œï¼šPython venv éš”ç¦»ã€èµ„æºé…é¢ï¼ˆCPU/å†…å­˜ï¼‰ã€è¶…æ—¶æ§åˆ¶ã€‚ ä¾èµ–æ²»ç†ï¼šå¤š venv å¹¶è¡Œï¼ŒåŠ¨æ€åˆ›å»º/é”€æ¯ï¼ŒæŒ‰éœ€æ±‚å®‰è£…ä¾èµ–ã€‚ å‚æ•°å®‰å…¨ï¼šè¾“å…¥/è¾“å‡ºåŒå‘æ ¡éªŒï¼Œé»˜è®¤æ‹’ç»ä¸åˆè§„è¯·æ±‚ã€‚ å®¡è®¡æº¯æºï¼šæ‰§è¡Œæ—¥å¿—è½åº“ï¼Œå«è°ƒç”¨å‚æ•°ã€è¿è¡Œè€—æ—¶ã€å‡ºé”™å †æ ˆã€‚ äº‹ä»¶é©±åŠ¨ï¼šæ”¯æŒ Kafka è§¦å‘ï¼Œæ–¹ä¾¿æ¥å…¥å¼‚æ­¥é“¾è·¯ã€‚ å¯è§‚æµ‹æ€§ï¼šæŒ‡æ ‡æš´éœ²ï¼ˆPrometheusï¼‰ã€æŒ‰ä»»åŠ¡çº§åˆ«è®°å½•ã€‚ æœªæ¥åŠŸèƒ½ï¼Ÿ æ”¯æŒæµå¼è¾“å‡ºï¼ˆæ—¥å¿—/æ ‡å‡†è¾“å‡ºå®æ—¶æ¨é€ï¼‰ã€‚ å¢å¼ºéš”ç¦»ï¼ˆå®¹å™¨çº§ Cgroupã€ç½‘ç»œç™½åå•ï¼‰ã€‚ ä¸€é”®æ¨¡æ¿åŒ–ç”Ÿæˆâ€œèƒ½åŠ›/é¡¹ç›®â€å±•ç¤ºå¡ç‰‡ã€‚" }, { "title": "A2Aæµå¼ä¼ è¾“åè®®åˆ†æ", "url": "/posts/stream-communication/", "categories": "Learn, Work", "tags": "analysis, agent, AI", "date": "2025-12-03 08:00:00 +0800", "content": "What is A2A? The A2A protocol is an open standard that enables seamless communication and collaboration between AI agents. It provides a common language for agents built using diverse frameworks and by different vendors, fostering interoperability and breaking down silos. Agents are autonomous problem-solvers that act independently within their environment. A2A allows agents from different developers, built on different frameworks, and owned by different organizations to unite and work together. Why Use the A2A Protocol A2A addresses key challenges in AI agent collaboration. It provides a standardized approach for agents to interact. This section explains the problems A2A solves and the benefits it offers. Problems that A2A Solves Consider a user request for an AI assistant to plan an international trip. This task involves orchestrating multiple specialized agents, such as: A flight booking agent A hotel reservation agent An agent for local tour recommendations A currency conversion agent Without A2A, integrating these diverse agents presents several challenges: Agent Exposure: Developers often wrap agents as tools to expose them to other agents, similar to how tools are exposed in a Multi-agent Control Platform (Model Context Protocol). However, this approach is inefficient because agents are designed to negotiate directly. Wrapping agents as tools limits their capabilities. A2A allows agents to be exposed as they are, without requiring this wrapping. Custom Integrations: Each interaction requires custom, point-to-point solutions, creating significant engineering overhead. Slow Innovation: Bespoke development for each new integration slows innovation. Scalability Issues: Systems become difficult to scale and maintain as the number of agents and interactions grows. Interoperability: This approach limits interoperability, preventing the organic formation of complex AI ecosystems. Security Gaps: Ad hoc communication often lacks consistent security measures. The A2A protocol addresses these challenges by establishing interoperability for AI agents to interact reliably and securely. A2A Example Scenario This section provides an example scenario to illustrate the benefits of using an A2A (Agent2Agent) protocol for complex interactions between AI agents. A Userâ€™s Complex Request A user interacts with an AI assistant, giving it a complex prompt like â€œPlan an international trip.â€ graph LR User --&gt; Prompt --&gt; AI_Assistant[AI Assistant] The Need for Collaboration The AI assistant receives the prompt and realizes it needs to call upon multiple specialized agents to fulfill the request. These agents include a Flight Booking Agent, a Hotel Reservation Agent, a Currency Conversion Agent, and a Local Tours Agent. graph LR subgraph \"Specialized Agents\" FBA[âœˆï¸ Flight Booking Agent] HRA[ğŸ¨ Hotel Reservation Agent] CCA[ğŸ’± Currency Conversion Agent] LTA[ğŸšŒ Local Tours Agent] end AI_Assistant[ğŸ¤– AI Assistant] --&gt; FBA AI_Assistant --&gt; HRA AI_Assistant --&gt; CCA AI_Assistant --&gt; LTA The Interoperability Challenge The core problem: The agents are unable to work together because each has its own bespoke development and deployment. The consequence of a lack of a standardized protocol is that these agents cannot collaborate with each other let alone discover what they can do. The individual agents (Flight, Hotel, Currency, and Tours) are isolated. The â€œWith A2Aâ€ Solution The A2A Protocol provides standard methods and data structures for agents to communicate with one another, regardless of their underlying implementation, so the same agents can be used as an interconnected system, communicating seamlessly through the standardized protocol. The AI assistant, now acting as an orchestrator, receives the cohesive information from all the A2A-enabled agents. It then presents a single, complete travel plan as a seamless response to the userâ€™s initial prompt. Core Benefits of A2A Implementing the A2A protocol offers significant advantages across the AI ecosystem: Secure collaboration: Without a standard, itâ€™s difficult to ensure secure communication between agents. A2A uses HTTPS for secure communication and maintains opaque operations, so agents canâ€™t see the inner workings of other agents during collaboration. Interoperability: A2A breaks down silos between different AI agent ecosystems, enabling agents from various vendors and frameworks to work together seamlessly. Agent autonomy: A2A allows agents to retain their individual capabilities and act as autonomous entities while collaborating with other agents. Reduced integration complexity: The protocol standardizes agent communication, enabling teams to focus on the unique value their agents provide. Support for LRO: The protocol supports long-running operations (LRO) and streaming with Server-Sent Events (SSE) and asynchronous execution. Key Design Principles of A2A A2A development follows principles that prioritize broad adoption, enterprise-grade capabilities, and future-proofing. Simplicity: A2A leverages existing standards like HTTP, JSON-RPC, and Server-Sent Events (SSE). This avoids reinventing core technologies and accelerates developer adoption. Enterprise Readiness: A2A addresses critical enterprise needs. It aligns with standard web practices for robust authentication, authorization, security, privacy, tracing, and monitoring. Asynchronous: A2A natively supports long-running tasks. It handles scenarios where agents or users might not remain continuously connected. It uses mechanisms like streaming and push notifications. Modality Independent: The protocol allows agents to communicate using a wide variety of content types. This enables rich and flexible interactions beyond plain text. Opaque Execution: Agents collaborate effectively without exposing their internal logic, memory, or proprietary tools. Interactions rely on declared capabilities and exchanged context. This preserves intellectual property and enhances security. Understanding the Agent Stack: A2A, MCP, Agent Frameworks and Models A2A is situated within a broader agent stack, which includes: A2A: Standardizes communication among agents deployed in different organizations and developed using diverse frameworks. MCP: Connects models to data and external resources. Frameworks (like ADK): Provide toolkits for constructing agents. Models: Fundamental to an agentâ€™s reasoning, these can be any Large Language Model (LLM). A2A and MCP In the broader ecosystem of AI communication, you might be familiar with protocols designed to facilitate interactions between agents, models, and tools. Notably, the Model Context Protocol (MCP) is an emerging standard focused on connecting Large Language Models (LLMs) with data and external resources. The Agent2Agent (A2A) protocol is designed to standardize communication between AI agents, particularly those deployed in external systems. A2A is positioned to complement MCP, addressing a distinct yet related aspect of agent interaction. MCPâ€™s Focus: Reducing the complexity involved in connecting agents with tools and data. Tools are typically stateless and perform specific, predefined functions (e.g., a calculator, a database query). A2Aâ€™s Focus: Enabling agents to collaborate within their native modalities, allowing them to communicate as agents (or as users) rather than being constrained to tool-like interactions. This enables complex, multi-turn interactions where agents reason, plan, and delegate tasks to other agents. For example, this facilitates multi-turn interactions, such as those involving negotiation or clarification when placing an order. The practice of encapsulating an agent as a simple tool is fundamentally limiting, as it fails to capture the agentâ€™s full capabilities. This critical distinction is explored in the post, Why Agents Are Not Tools. A2A and ADK The Agent Development Kit (ADK) is an open-source agent development toolkit developed by Google. A2A is a communication protocol for agents that enables inter-agent communication, regardless of the framework used for their construction (e.g., ADK, LangGraph, or Crew AI). ADK is a flexible and modular framework for developing and deploying AI agents. While optimized for Gemini AI and the Google ecosystem, ADK is model-agnostic, deployment-agnostic, and built for compatibility with other frameworks. A2A Request Lifecycle The A2A request lifecycle is a sequence that details the four main steps a request follows: agent discovery, authentication, sendMessage API, and sendMessageStream API. The following diagram provides a deeper look into the operational flow, illustrating the interactions between the client, A2A server, and auth server. sequenceDiagram participant Client participant A2A Server participant Auth Server rect rgb(240, 240, 240) Note over Client, A2A Server: 1. Agent Discovery Client-&gt;&gt;A2A Server: GET agent card eg: (/.well-known/agent-card) A2A Server--&gt;&gt;Client: Returns Agent Card end rect rgb(240, 240, 240) Note over Client, Auth Server: 2. Authentication Client-&gt;&gt;Client: Parse Agent Card for securitySchemes alt securityScheme is \"openIdConnect\" Client-&gt;&gt;Auth Server: Request token based on \"authorizationUrl\" and \"tokenUrl\". Auth Server--&gt;&gt;Client: Returns JWT end end rect rgb(240, 240, 240) Note over Client, A2A Server: 3. sendMessage API Client-&gt;&gt;Client: Parse Agent Card for \"url\" param to send API requests to. Client-&gt;&gt;A2A Server: POST /sendMessage (with JWT) A2A Server-&gt;&gt;A2A Server: Process message and create task A2A Server--&gt;&gt;Client: Returns Task Response end rect rgb(240, 240, 240) Note over Client, A2A Server: 4. sendMessageStream API Client-&gt;&gt;A2A Server: POST /sendMessageStream (with JWT) A2A Server--&gt;&gt;Client: Stream: Task (Submitted) A2A Server--&gt;&gt;Client: Stream: TaskStatusUpdateEvent (Working) A2A Server--&gt;&gt;Client: Stream: TaskArtifactUpdateEvent (artifact A) A2A Server--&gt;&gt;Client: Stream: TaskArtifactUpdateEvent (artifact B) A2A Server--&gt;&gt;Client: Stream: TaskStatusUpdateEvent (Completed) end Whatâ€™s Next" }, { "title": "12æœˆ2å·-æœ¬æ—¥å·¥ä½œ", "url": "/posts/daily-work/", "categories": "Work", "tags": "balabala", "date": "2025-12-02 09:00:00 +0800", "content": "æœ¬æ—¥å·¥ä½œå†…å®¹ å°è‰ºA2Aæ¥å…¥è°ƒç ” å€Ÿç”¨ChatGPTä»¥åŠCodexå®Œæˆäº†ä¸€ä¸ªåŸºäºfastapiçš„æ ·ä¾‹ æ¥å£è¦æ±‚ è°ƒç ”ç»“æœï¼Œ ä¸€å…±éœ€è¦å†™9ä¸ªæ¥å£å¯¹æ¥å½“å‰çš„æ‰€æœ‰é¡¹ç›® UserId,å¦‚æœæœªå‘ç°ï¼Œç”±å‰ç«¯ç”Ÿæˆçš„ï¼Œè§„åˆ™æ˜¯uuid.uuid1 æ²™ç›’ä»£ç å®¡æŸ¥ å‘ç°ç¯å¢ƒä¿®æ”¹ç±»APIæœªæ·»åŠ å¹¶è¡Œæ£€æŸ¥ï¼ˆåŒä¸€æ—¶é—´åªå…è®¸ä¸€äººè¿›è¡Œç¯å¢ƒä¿®æ”¹ï¼‰ â€” å·²ä¿®å¤ å‘ç°åˆ›å»ºè™šæ‹Ÿç¯å¢ƒä¸ºå¯¹é»˜è®¤ç±»å‹è¿›è¡Œé™åˆ¶ï¼ˆdefault, baseï¼‰ï¼Œ â€” å·²ä¿®å¤ å‘ç°åˆ›å»ºè™šæ‹Ÿç¯å¢ƒçš„libpathåœ¨ä»£ç å±‚ç¡¬å†™äº†ç‰ˆæœ¬å· â€” å·²ä¿®å¤ å‘ç°ä¿®æ”¹ç¯å¢ƒç±»çš„APIæ²¡æœ‰mutation checkï¼Œå¯èƒ½ä¼šé€ æˆå¹²æ‰° â€” å·²ä¿®å¤ å‘ç°æ·»åŠ ä¾èµ–ï¼Œæ£€æŸ¥è™šæ‹Ÿç¯å¢ƒä¾èµ–æ¥å£æ²¡æœ‰å¢åŠ è™šæ‹Ÿç¯å¢ƒæ˜¯å¦å­˜åœ¨çš„æ£€æµ‹ â€” å·²ä¿®å¤ Jekyll ä¿®æ”¹ ä¿®æ”¹çš„å½“å‰é¡¹ç›®çš„åç§°å’Œdescriptionï¼Œæ·»åŠ äº†å¯¹åº”é‚®ç®± å‘ç°æœ‰ä¸¤ä¸ªæ‰¾ä¸åˆ°çš„min.jsï¼Œæœ‰æœºä¼šè¦å¤„ç†ä¸€ä¸‹" } ]
